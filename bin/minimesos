#!/bin/sh

MINIMESOS_TAG="latest"
MESOS_TAG="0.25.0-0.2.70.ubuntu1404"

PARAMS="$@"

command_exists() {
	command -v "$@" > /dev/null 2>&1
}

if ! command_exists docker; then
	echo "Please install docker to use minimesos"
	exit 1
fi

if command_exists docker-machine; then
    DOCKER_HOST_IP=$(docker-machine ip ${DOCKER_MACHINE_NAME})
elif [ $(uname) != "Darwin" ]; then
    DOCKER_HOST_IP=$(hostname --ip-address)
else
    DOCKER_HOST_IP=""
fi

DOCKER_BIN=/usr/local/bin/docker
if [ ! -f $DOCKER_BIN ]; then
    DOCKER_BIN=/usr/bin/docker
fi

pullImage() {
  if [ "$(docker images $1 | grep $2 2> /dev/null)" = "" ]; then
    echo "Pulling $1:$2"
    docker pull "$1:$2"
  fi
}

if [ $PARAMS = "up" ]; then
    pullImage "containersol/minimesos" ${MINIMESOS_TAG}
    pullImage "containersol/mesos-agent" ${MESOS_TAG}
    pullImage "containersol/mesos-master" ${MESOS_TAG}
    if [ $(uname) == "Darwin" ]; then
        echo "You are running minimesos on OS X, enabling --exposedHostPorts"
        PARAMS="${PARAMS} --exposedHostPorts"
    fi
fi

MINIMESOS_DIR=$(pwd)/.minimesos
mkdir -p $MINIMESOS_DIR

docker run --rm -v $MINIMESOS_DIR:/tmp/.minimesos \
    -v /var/lib/docker:/var/lib/docker \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -v $DOCKER_BIN:$DOCKER_BIN \
    -v /sys/fs/cgroup:/sys/fs/cgroup \
    --env DOCKER_HOST_IP=$DOCKER_HOST_IP \
    containersol/minimesos:$MINIMESOS_TAG $PARAMS
